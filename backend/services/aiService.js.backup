/**
 * AI Service - Document Summary and Analysis
 * Uses Google Gemini API for intelligent document processing
 */

const { GoogleGenerativeAI } = require('@google/generative-ai');
const fs = require('fs');

// Lazy initialization - get API instance when needed
function getGenAI() {
  const apiKey = process.env.GEMINI_API_KEY;
  if (!apiKey) {
    throw new Error('GEMINI_API_KEY not found in environment variables');
  }
  return new GoogleGenerativeAI(apiKey);
}

/**
 * Convert file buffer to Gemini-compatible format
 */
function fileToGenerativePart(fileBuffer, mimeType) {
  const base64Data = fileBuffer.toString('base64');
  return {
    inlineData: {
      data: base64Data,
      mimeType: mimeType,
    },
  };
}

/**
 * Analyze scanned images with vision capabilities (JPG/PNG only)
 */
async function analyzeScannedImage(filePath, mimeType, documentMetadata = {}) {
  try {
    const genAI = getGenAI();
    const model = genAI.getGenerativeModel({ 
      model: 'gemini-1.5-pro'
    });

    const prompt = `You are the AI engine for 'Pravah', the Uttarakhand Government Document Management System.
Analyze this scanned document image. The document might be in Hindi, English, or both.

Extract and analyze the content, then respond ONLY with valid JSON (no markdown, no code blocks):

{
  "summary": "A concise summary (2-3 sentences) of the document content",
  "keyPoints": ["Key point 1", "Key point 2", "Key point 3"],
  "priority": "High/Medium/Low",
  "deadlines": ["date1", "date2"],
  "actionItems": ["action1", "action2"]
}

Document Title: ${documentMetadata.title || 'Untitled'}
Document Category: ${documentMetadata.category || 'General'}

If handwritten or unclear, infer context from visible elements.`;

    // Read file and convert to base64
    const fileBuffer = fs.readFileSync(filePath);
    const imagePart = fileToGenerativePart(fileBuffer, mimeType);

    console.log('ðŸ“¤ Sending scanned image to Gemini Vision API...');
    const result = await model.generateContent([prompt, imagePart]);
    const response = result.response;
    let text = response.text();

    console.log('ðŸ“¥ Gemini Vision Response received');
    
    // Clean JSON response (remove code blocks if present)
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    // Parse JSON response
    const analysis = JSON.parse(text);
    
    return {
      summary: analysis.summary || analysis.subject || 'Document analyzed',
      keyPoints: analysis.keyPoints || [],
      deadlines: analysis.deadlines || [],
      priority: analysis.priority || analysis.urgency || 'Medium',
      actionItems: analysis.actionItems || []
    };

  } catch (error) {
    console.error('Gemini Vision Analysis Failed:', error);
    throw error;
  }
}

/**
 * Generate document summary using Gemini AI (text-based analysis)
 */
async function analyzeDocumentText(documentText, documentMetadata = {}) {
  try {
    const genAI = getGenAI();
    const model = genAI.getGenerativeModel({ 
      model: 'gemini-pro'
    });

    const prompt = `You are the AI assistant for 'Pravah', the Uttarakhand Government Document Management System.

Analyze this government document and provide detailed analysis.

Document Title: ${documentMetadata.title || 'Untitled'}
Document Category: ${documentMetadata.category || 'General'}

Document Content:
${documentText}

Respond ONLY with valid JSON (no markdown, no code blocks):

{
  "summary": "Concise summary (2-3 sentences)",
  "keyPoints": ["point 1", "point 2", "point 3"],
  "deadlines": ["date1", "date2"],
  "priority": "High/Medium/Low",
  "actionItems": ["action1", "action2"]
}`;

    const result = await model.generateContent(prompt);
    const response = result.response;
    let text = response.text();
    
    console.log('ðŸ“¥ Gemini Text Analysis Response received');
    
    // Clean JSON response (remove code blocks if present)
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    // Parse JSON response
    const analysis = JSON.parse(text);
    
    return {
      summary: analysis.summary || 'Analysis completed',
      keyPoints: analysis.keyPoints || [],
      deadlines: analysis.deadlines || [],
      priority: analysis.priority || 'Medium',
      actionItems: analysis.actionItems || []
    };

  } catch (error) {
    console.error('AI Summary Error:', error);
    return {
      summary: documentText.substring(0, 500) + '...',
      keyPoints: ['Document uploaded successfully'],
      deadlines: [],
      priority: 'Medium',
      actionItems: []
    };
  }
}

/**
 * AI-based routing suggestions
 */
async function suggestRouting(documentText, documentMetadata) {
  try {
    const genAI = getGenAI();
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

    const prompt = `You are an AI routing assistant for a government document management system.

Analyze this document and suggest which department(s) should handle it.

Available Departments:
- Finance Department (handles: budget, payments, financial approvals, audit)
- Land & Revenue Department (handles: land records, property, revenue collection)
- Agriculture Department (handles: farming, irrigation, crop management)
- Human Resources (handles: employee matters, recruitment, training)
- Infrastructure (handles: construction, maintenance, public works)
- Legal & Compliance (handles: legal matters, contracts, compliance)

Document Title: ${documentMetadata.title}
Category: ${documentMetadata.category}
Content: ${documentText.substring(0, 1000)}

Respond in JSON format with routing suggestions:
{
  "primaryDepartment": "Department Name",
  "secondaryDepartments": ["Dept 1", "Dept 2"],
  "reasoning": "Why this routing is suggested",
  "urgency": "High/Medium/Low"
}`;

    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = response.text();
    
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }

    return {
      primaryDepartment: 'General Administration',
      secondaryDepartments: [],
      reasoning: 'Default routing',
      urgency: 'Medium'
    };

  } catch (error) {
    console.error('AI Routing Error:', error);
    return {
      primaryDepartment: 'General Administration',
      secondaryDepartments: [],
      reasoning: 'Automatic routing failed, manual review required',
      urgency: 'Medium'
    };
  }
}

// Backward compatibility
const generateSummary = analyzeDocumentText;
const analyzeDocumentWithVision = analyzeScannedImage;

module.exports = {
  analyzeDocumentText,
  analyzeScannedImage,
  suggestRouting,
  // Deprecated - for backward compatibility
  generateSummary,
  analyzeDocumentWithVision
};
